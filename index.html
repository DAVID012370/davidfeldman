<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DJ Visualizer – Visual + Logo Views</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #141927, #050609 60%);
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      padding: 1.5rem 1.75rem 2rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 1.25rem;
    }

    .title-block h1 {
      font-size: 1.6rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .title-block p {
      font-size: 0.82rem;
      margin-top: 0.15rem;
      opacity: 0.75;
    }

    .view-toggle {
      display: flex;
      gap: 0.5rem;
    }

    .pill-toggle {
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      font-size: 0.8rem;
      border: 1px solid rgba(255,255,255,0.25);
      background: radial-gradient(circle at top, #25223a, #11111a);
      color: #f5f5f5;
      cursor: pointer;
      transition: all 0.18s ease-out;
      box-shadow: 0 0 0 rgba(255,0,150,0.0);
    }

    .pill-toggle.active {
      background: radial-gradient(circle at top, #ff3da0, #b326ff);
      box-shadow: 0 0 18px rgba(255, 61, 160, 0.55);
      border-color: transparent;
    }

    .pill-toggle:focus-visible {
      outline: 2px solid #4fc3ff;
      outline-offset: 2px;
    }

    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }

    .left-controls,
    .right-controls {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      flex-wrap: wrap;
    }

    label.control-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      opacity: 0.75;
    }

    select,
    button.chip-btn {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(5, 5, 10, 0.85);
      color: #f5f5f5;
      padding: 0.35rem 0.85rem;
      font-size: 0.8rem;
      cursor: pointer;
      outline: none;
      transition: all 0.16s ease-out;
    }

    select {
      padding-right: 1.8rem;
      background-image: linear-gradient(45deg, transparent 50%, #f5f5f5 50%), linear-gradient(135deg, #f5f5f5 50%, transparent 50%);
      background-position: calc(100% - 13px) calc(50% - 3px), calc(100% - 8px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      appearance: none;
    }

    select:focus-visible,
    .chip-btn:focus-visible {
      outline: 2px solid #4fc3ff;
      outline-offset: 2px;
    }

    button.chip-btn {
      border-radius: 999px;
      padding: 0.4rem 1.1rem;
      border: none;
      background: radial-gradient(circle at top, #ff3da0, #b326ff);
      box-shadow: 0 0 15px rgba(255, 61, 160, 0.5);
    }

    button.chip-btn.secondary {
      background: radial-gradient(circle at top, #262337, #14121e);
      box-shadow: none;
      border: 1px solid rgba(255,255,255,0.23);
    }

    button.chip-btn.ghost {
      background: transparent;
      border-color: rgba(255,255,255,0.2);
      box-shadow: none;
    }

    button.chip-btn:hover {
      filter: brightness(1.08);
      transform: translateY(-0.5px);
    }

    .visual-wrapper {
      margin-top: 0.5rem;
      border-radius: 24px;
      background: radial-gradient(circle at top, #141927, #050609 60%);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow:
        0 24px 80px rgba(0,0,0,0.7),
        0 0 0 1px rgba(255,255,255,0.02);
      padding: 0.9rem;
      position: relative;
      overflow: hidden;
    }

    #dropZone {
      position: relative;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.08);
      overflow: hidden;
      cursor: pointer;
    }

    #visualCanvas {
      display: block;
      width: 100%;
      height: 440px;
    }

    .drop-hint {
      position: absolute;
      left: 1.25rem;
      top: 1rem;
      font-size: 0.76rem;
      opacity: 0.75;
      pointer-events: none;
    }

    .footer-tag {
      position: absolute;
      right: 1.25rem;
      bottom: 0.9rem;
      font-size: 0.7rem;
      opacity: 0.7;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .timeline-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-top: 0.8rem;
      font-size: 0.78rem;
    }

    .time-label {
      width: 2.8rem;
      text-align: center;
      opacity: 0.8;
    }

    input[type="range"].timeline {
      flex: 1;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      outline: none;
    }

    input[type="range"].timeline::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #ff3da0;
      box-shadow: 0 0 12px rgba(255,61,160,0.7);
      cursor: pointer;
      margin-top: -4px;
    }

    .audio-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-top: 0.9rem;
      flex-wrap: wrap;
      font-size: 0.82rem;
    }

    .audio-buttons {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .audio-buttons button {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(10,10,18,0.92);
      color: #f5f5f5;
      padding: 0.35rem 0.9rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s ease-out;
    }

    .audio-buttons button.primary {
      border: none;
      background: radial-gradient(circle at top, #ff3da0, #b326ff);
      box-shadow: 0 0 15px rgba(255,61,160,0.45);
    }

    .audio-buttons button.danger {
      background: transparent;
      border-color: rgba(255,130,130,0.7);
      color: #ff9e9e;
    }

    .audio-buttons button:hover {
      filter: brightness(1.08);
      transform: translateY(-0.5px);
    }

    .volume-wrap {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .volume-wrap span {
      font-size: 0.78rem;
      opacity: 0.8;
    }

    input[type="range"].volume {
      width: 120px;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      outline: none;
    }

    input[type="range"].volume::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #4fc3ff;
      box-shadow: 0 0 12px rgba(79,195,255,0.7);
      cursor: pointer;
      margin-top: -4px;
    }

    .audio-note {
      flex: 1;
      text-align: left;  /* <-- מיושר שמאלה במקום ימינה */
      font-size: 0.76rem;
      opacity: 0.7;
    }

    .now-playing {
      margin-top: 0.45rem;
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .now-playing span {
      opacity: 0.7;
    }

    @media (max-width: 800px) {
      #visualCanvas {
        height: 320px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      .audio-note {
        text-align: left;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <h1>DJ VISUALIZER</h1>
      <p>Audio reactive visuals · XP vibes soon</p>
    </div>
    <div class="view-toggle">
      <button class="pill-toggle active" id="visualizerViewBtn">Visualizer</button>
      <button class="pill-toggle" id="logoViewBtn">Logo</button>
    </div>
  </header>

  <div class="controls-row">
    <div class="left-controls">
      <div>
        <label class="control-label" for="themeSelect">Theme</label><br />
        <select id="themeSelect">
          <option value="neon">Neon</option>
          <option value="midnight">Midnight</option>
          <option value="sunset">Sunset</option>
        </select>
      </div>

      <div>
        <label class="control-label" for="visualizerSelect">Visualizer</label><br />
        <select id="visualizerSelect">
          <option value="bars">Bars</option>
          <option value="circle">Circle</option>
          <option value="wave">Waveform</option>
        </select>
      </div>

      <div>
        <label class="control-label" for="fxSelect">FX</label><br />
        <select id="fxSelect">
          <option value="none">Clean</option>
          <option value="glitch">Glitch</option>
        </select>
      </div>

      <div>
        <label class="control-label" for="fxStrengthSelect">FX Strength</label><br />
        <select id="fxStrengthSelect">
          <option value="soft">Soft</option>
          <option value="medium">Medium</option>
          <option value="hardcore">Hardcore</option>
        </select>
      </div>

      <div>
        <label class="control-label">Logo</label><br />
        <button class="chip-btn secondary" id="logoUploadBtn">Logo</button>
        <button class="chip-btn ghost" id="logoClearBtn">Logo X</button>
      </div>
    </div>

    <div class="right-controls">
      <button class="chip-btn" id="downloadPngBtn">DL PNG</button>
      <button class="chip-btn secondary" id="recordBtn">REC</button>
      <button class="chip-btn secondary" id="savePresetBtn">SAVE</button>
      <button class="chip-btn secondary" id="loadPresetBtn">LOAD</button>
    </div>
  </div>

  <div class="visual-wrapper">
    <div id="dropZone">
      <canvas id="visualCanvas"></canvas>
      <div class="drop-hint">
        Drag & drop audio or logo here.
      </div>
      <div class="footer-tag" id="footerTag">
        SPECTRUM · NEON · BARS · CLEAN
      </div>
    </div>
  </div>

  <div class="timeline-row">
    <div class="time-label" id="currentTimeLabel">0:00</div>
    <input type="range" min="0" max="100" value="0" class="timeline" id="timelineRange" />
    <div class="time-label" id="durationLabel">0:00</div>
  </div>

  <div class="audio-row">
    <div class="audio-buttons">
      <button id="loadTrackBtn">Load Track</button>
      <button class="primary" id="playPauseBtn">Play</button>
      <button id="clearAudioBtn" class="danger">Clear</button>
      <div class="volume-wrap">
        <span>Vol</span>
        <input type="range" min="0" max="1" step="0.01" value="0.9" class="volume" id="volumeRange" />
      </div>
      <button id="downloadAudioBtn">DL Audio</button>
    </div>
    <div class="audio-note">
      Space = Play/Pause · P = Performance mode.
    </div>
  </div>

  <div class="now-playing" id="nowPlaying">
    <span>Now Playing:</span> — none —
  </div>

  <!-- Hidden inputs -->
  <input type="file" id="audioInput" accept="audio/*" style="display:none" />
  <input type="file" id="logoInput" accept="image/png,image/jpeg,image/jpg" style="display:none" />
  <audio id="audioElement" crossorigin="anonymous"></audio>
</div>

<script>
  const audioEl = document.getElementById("audioElement");
  const loadTrackBtn = document.getElementById("loadTrackBtn");
  const playPauseBtn = document.getElementById("playPauseBtn");
  const audioInput = document.getElementById("audioInput");
  const volumeRange = document.getElementById("volumeRange");
  const clearAudioBtn = document.getElementById("clearAudioBtn");
  const downloadAudioBtn = document.getElementById("downloadAudioBtn");
  const nowPlayingEl = document.getElementById("nowPlaying");

  const timelineRange = document.getElementById("timelineRange");
  const currentTimeLabel = document.getElementById("currentTimeLabel");
  const durationLabel = document.getElementById("durationLabel");

  let audioCtx;
  let analyser;
  let dataArray;
  let sourceNode;
  let gainNode;
  let isPlaying = false;
  let audioLoaded = false;
  let lastAudioFile = null;
  let lastAudioFileName = "";

  function initAudioContext() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      const bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);

      gainNode = audioCtx.createGain();
      gainNode.gain.value = parseFloat(volumeRange.value);

      sourceNode = audioCtx.createMediaElementSource(audioEl);
      sourceNode.connect(gainNode);
      gainNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
  }

  function formatTime(sec) {
    if (!isFinite(sec)) return "0:00";
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return m + ":" + (s < 10 ? "0" + s : s);
  }

  function updateNowPlaying(name) {
    nowPlayingEl.innerHTML = '<span>Now Playing:</span> ' + (name || "— none —");
  }

  function loadAudioFile(file) {
    if (!file) return;
    const url = URL.createObjectURL(file);
    audioEl.src = url;
    audioEl.load();
    audioLoaded = true;
    lastAudioFile = file;
    lastAudioFileName = file.name || "track";
    updateNowPlaying(lastAudioFileName);
    playPauseBtn.textContent = "Play";
  }

  loadTrackBtn.addEventListener("click", () => {
    audioInput.click();
  });

  audioInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      loadAudioFile(file);
    }
  });

  playPauseBtn.addEventListener("click", () => {
    togglePlayPause();
  });

  function togglePlayPause() {
    if (!audioLoaded) return;
    initAudioContext();
    if (!isPlaying) {
      audioEl.play();
      isPlaying = true;
      playPauseBtn.textContent = "Pause";
    } else {
      audioEl.pause();
      isPlaying = false;
      playPauseBtn.textContent = "Play";
    }
  }

  clearAudioBtn.addEventListener("click", () => {
    audioEl.pause();
    audioEl.currentTime = 0;
    isPlaying = false;
    playPauseBtn.textContent = "Play";
    audioLoaded = false;
    lastAudioFile = null;
    lastAudioFileName = "";
    updateNowPlaying("— none —");
  });

  volumeRange.addEventListener("input", () => {
    if (gainNode) {
      gainNode.gain.value = parseFloat(volumeRange.value);
    }
  });

  downloadAudioBtn.addEventListener("click", () => {
    if (!lastAudioFile) {
      alert("No local audio file loaded.");
      return;
    }
    const a = document.createElement("a");
    a.href = URL.createObjectURL(lastAudioFile);
    a.download = lastAudioFileName || "audio";
    a.click();
  });

  audioEl.addEventListener("timeupdate", () => {
    if (!audioEl.duration || isNaN(audioEl.duration)) return;
    const progress = (audioEl.currentTime / audioEl.duration) * 100;
    timelineRange.value = progress;
    currentTimeLabel.textContent = formatTime(audioEl.currentTime);
    durationLabel.textContent = formatTime(audioEl.duration);
  });

  timelineRange.addEventListener("input", () => {
    if (!audioEl.duration || isNaN(audioEl.duration)) return;
    const pct = parseFloat(timelineRange.value) / 100;
    audioEl.currentTime = audioEl.duration * pct;
  });

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space" && !e.target.matches("input, textarea, select")) {
      e.preventDefault();
      if (audioLoaded) togglePlayPause();
    }
  });

  const canvas = document.getElementById("visualCanvas");
  const ctx = canvas.getContext("2d");
  const dropZone = document.getElementById("dropZone");
  const footerTag = document.getElementById("footerTag");

  const themeSelect = document.getElementById("themeSelect");
  const visualizerSelect = document.getElementById("visualizerSelect");
  const fxSelect = document.getElementById("fxSelect");
  const fxStrengthSelect = document.getElementById("fxStrengthSelect");

  const visualizerViewBtn = document.getElementById("visualizerViewBtn");
  const logoViewBtn = document.getElementById("logoViewBtn");

  let theme = themeSelect.value;
  let visualizerType = visualizerSelect.value;
  let fxMode = "none";
  let fxStrength = "soft";
  let visualizerEnabled = true;
  let logoEnabled = false;
  let lastEnergy = 0;

  let canvasDisplayWidth = 0;
  let canvasDisplayHeight = 440;

  function resizeCanvas() {
    const rect = dropZone.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;

    canvasDisplayWidth = rect.width;
    canvasDisplayHeight = 440;

    canvas.width = canvasDisplayWidth * dpr;
    canvas.height = canvasDisplayHeight * dpr;
    canvas.style.height = canvasDisplayHeight + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function drawBackground() {
    const w = canvasDisplayWidth;
    const h = canvasDisplayHeight;
    const g = ctx.createRadialGradient(
      w / 2,
      h * 0.1,
      0,
      w / 2,
      h / 2,
      Math.max(w, h)
    );

    if (theme === "neon") {
      g.addColorStop(0, "#1b2145");
      g.addColorStop(0.5, "#060712");
      g.addColorStop(1, "#020308");
    } else if (theme === "midnight") {
      g.addColorStop(0, "#101826");
      g.addColorStop(0.5, "#05060b");
      g.addColorStop(1, "#000000");
    } else {
      g.addColorStop(0, "#ff7a88");
      g.addColorStop(0.45, "#251432");
      g.addColorStop(1, "#050408");
    }

    ctx.fillStyle = g;
    ctx.fillRect(0, 0, w, h);

    ctx.globalAlpha = 0.06;
    ctx.fillStyle = "#ffffff";
    const stripeH = 2;
    for (let y = 0; y < h; y += 20) {
      ctx.fillRect(0, y, w, stripeH);
    }
    ctx.globalAlpha = 1;
  }

  function computeEnergy() {
    if (!analyser || !dataArray) return 0;
    analyser.getByteFrequencyData(dataArray);
    let sum = 0;
    for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
    const avg = sum / dataArray.length / 255;
    lastEnergy = avg;
    return avg;
  }

  function drawBars() {
    if (!analyser || !dataArray) return;

    const w = canvasDisplayWidth;
    const h = canvasDisplayHeight;
    const barCount = 120;
    const barWidth = w / barCount;

    for (let i = 0; i < barCount; i++) {
      const idx = Math.floor((i / barCount) * dataArray.length);
      const v = dataArray[idx] / 255;
      const barH = v * h * 0.48;
      const x = i * barWidth;
      const y = h / 2;

      const grad = ctx.createLinearGradient(x, y - barH, x, y + barH);
      grad.addColorStop(0, "#4fc3ff");
      grad.addColorStop(0.5, "#b326ff");
      grad.addColorStop(1, "#ff3da0");

      ctx.save();
      ctx.beginPath();
      ctx.roundRect(x + 1, y - barH, barWidth - 2, barH * 2, 999);
      ctx.fillStyle = grad;
      ctx.fill();
      ctx.restore();
    }

    ctx.globalAlpha = 0.3;
    ctx.fillStyle = "#f5f5f5";
    ctx.fillRect(0, h / 2, w, 1);
    ctx.globalAlpha = 1;
  }

  function drawCircle() {
    if (!analyser || !dataArray) return;
    const w = canvasDisplayWidth;
    const h = canvasDisplayHeight;
    const energy = computeEnergy();
    const cx = w / 2;
    const cy = h / 2;
    const baseRadius = Math.min(w, h) * 0.18;
    const innerRadius = baseRadius * (1 - 0.12 * (energy + 0.2));

    const glow = ctx.createRadialGradient(
      cx,
      cy,
      innerRadius * 0.6,
      cx,
      cy,
      baseRadius * 1.6
    );
    glow.addColorStop(0, "rgba(79,195,255,0.45)");
    glow.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = glow;
    ctx.beginPath();
    ctx.arc(cx, cy, baseRadius * 1.6, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,0.75)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(cx, cy, innerRadius, 0, Math.PI * 2);
    ctx.stroke();

    const tickCount = 160;
    for (let i = 0; i < tickCount; i++) {
      const idx = Math.floor((i / tickCount) * dataArray.length);
      const v = dataArray[idx] / 255;
      const amp = v * 40 * (0.8 + energy);
      const a = (i / tickCount) * Math.PI * 2;

      const x1 = cx + Math.cos(a) * innerRadius;
      const y1 = cy + Math.sin(a) * innerRadius;
      const x2 = cx + Math.cos(a) * (innerRadius + amp);
      const y2 = cy + Math.sin(a) * (innerRadius + amp);

      ctx.strokeStyle = `rgba(79,195,255,${0.3 + v * 0.7})`;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
    }
  }

  function drawWaveform() {
    if (!analyser || !dataArray) return;
    const w = canvasDisplayWidth;
    const h = canvasDisplayHeight;

    analyser.getByteTimeDomainData(dataArray);
    ctx.lineWidth = 3;
    const grad = ctx.createLinearGradient(0, 0, w, 0);
    grad.addColorStop(0, "#4fc3ff");
    grad.addColorStop(0.5, "#b326ff");
    grad.addColorStop(1, "#ff3da0");
    ctx.strokeStyle = grad;

    ctx.beginPath();
    const slice = w / dataArray.length;
    for (let i = 0; i < dataArray.length; i++) {
      const v = dataArray[i] / 128.0;
      const y = (v * h) / 2;
      const x = i * slice;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
  }

  const logoInput = document.getElementById("logoInput");
  const logoUploadBtn = document.getElementById("logoUploadBtn");
  const logoClearBtn = document.getElementById("logoClearBtn");
  const downloadPngBtn = document.getElementById("downloadPngBtn");
  const recordBtn = document.getElementById("recordBtn");
  const savePresetBtn = document.getElementById("savePresetBtn");
  const loadPresetBtn = document.getElementById("loadPresetBtn");

  let logoImage = null;
  let logoLoaded = false;

  const logoBuffer = document.createElement("canvas");
  const logoBufferCtx = logoBuffer.getContext("2d");

  function getGlitchStrengthFactor() {
    switch (fxStrength) {
      case "hardcore":
        return 1.0;
      case "medium":
        return 0.55;
      case "soft":
      default:
        return 0.3;
    }
  }

  function renderLogoFrame(mainCtx) {
    if (!logoLoaded || !logoImage) return;

    const w = canvasDisplayWidth;
    const h = canvasDisplayHeight;

    logoBuffer.width = w;
    logoBuffer.height = h;
    logoBufferCtx.clearRect(0, 0, w, h);

    const maxW = w * 0.55;
    const maxH = h * 0.55;
    const ratio = logoImage.width / logoImage.height;
    let drawW = maxW;
    let drawH = drawW / ratio;
    if (drawH > maxH) {
      drawH = maxH;
      drawW = drawH * ratio;
    }
    const dx = (w - drawW) / 2;
    const dy = (h - drawH) / 2;

    logoBufferCtx.drawImage(logoImage, dx, dy, drawW, drawH);

    mainCtx.drawImage(logoBuffer, 0, 0);

    if (fxMode === "glitch") {
      const energy = Math.min(lastEnergy * 1.4 + 0.15, 1);
      const strength = getGlitchStrengthFactor() * energy;
      drawLogoGlitchPieces(mainCtx, strength);
    }
  }

  function drawLogoGlitchPieces(mainCtx, strength) {
    const w = logoBuffer.width;
    const h = logoBuffer.height;
    if (!w || !h || strength <= 0.01) return;

    const tileSize = Math.round(w / 14);
    const tilesX = Math.ceil(w / tileSize);
    const tilesY = Math.ceil(h / tileSize);
    const totalTiles = tilesX * tilesY;
    const glitchCount = Math.round(totalTiles * (0.08 + 0.25 * strength));

    for (let i = 0; i < glitchCount; i++) {
      const sxIndex = Math.floor(Math.random() * tilesX);
      const syIndex = Math.floor(Math.random() * tilesY);

      const sx = sxIndex * tileSize;
      const sy = syIndex * tileSize;
      const sw = tileSize;
      const sh = tileSize;

      const sample = logoBufferCtx.getImageData(sx, sy, sw, sh);
      let sum = 0;
      for (let j = 0; j < sample.data.length; j += 4) {
        sum += sample.data[j] + sample.data[j + 1] + sample.data[j + 2];
      }
      const avg = sum / (sample.data.length / 4) / 255;
      if (avg < 0.05) continue;

      const maxOffset = tileSize * (0.18 + 0.35 * strength);
      const offsetX = (Math.random() - 0.5) * maxOffset;
      const offsetY = (Math.random() - 0.5) * maxOffset;

      const maxAngle = (6 + 6 * strength) * (Math.PI / 180);
      const angle = (Math.random() - 0.5) * maxAngle;

      const dx = sx + offsetX;
      const dy = sy + offsetY;

      mainCtx.save();
      mainCtx.translate(dx + sw / 2, dy + sh / 2);
      mainCtx.rotate(angle);

      mainCtx.drawImage(
        logoBuffer,
        sx,
        sy,
        sw,
        sh,
        -sw / 2,
        -sh / 2,
        sw,
        sh
      );

      mainCtx.restore();
    }
  }

  logoUploadBtn.addEventListener("click", () => {
    logoInput.click();
  });

  logoInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) loadLogoFile(file);
  });

  function loadLogoFile(file) {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => {
      logoImage = img;
      logoLoaded = true;
      URL.revokeObjectURL(url);
    };
    img.src = url;
  }

  logoClearBtn.addEventListener("click", () => {
    logoLoaded = false;
    logoImage = null;
  });

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
  });

  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    const files = e.dataTransfer.files;
    if (!files || !files.length) return;
    const file = files[0];

    if (file.type.startsWith("audio")) {
      loadAudioFile(file);
    } else if (file.type.startsWith("image")) {
      loadLogoFile(file);
    }
  });

  visualizerViewBtn.addEventListener("click", () => {
    visualizerEnabled = !visualizerEnabled;
    visualizerViewBtn.classList.toggle("active", visualizerEnabled);
  });

  logoViewBtn.addEventListener("click", () => {
    logoEnabled = !logoEnabled;
    logoViewBtn.classList.toggle("active", logoEnabled);
  });

  themeSelect.addEventListener("change", () => {
    theme = themeSelect.value;
  });

  visualizerSelect.addEventListener("change", () => {
    visualizerType = visualizerSelect.value;
  });

  fxSelect.addEventListener("change", () => {
    fxMode = fxSelect.value === "glitch" ? "glitch" : "none";
  });

  fxStrengthSelect.addEventListener("change", () => {
    fxStrength = fxStrengthSelect.value;
  });

  function updateFooterTag() {
    const modeLabel = visualizerEnabled && logoEnabled
      ? "VISUAL + LOGO"
      : visualizerEnabled
      ? "VISUAL"
      : logoEnabled
      ? "LOGO"
      : "IDLE";

    const fxLabel = fxMode === "glitch" ? "GLITCH" : "CLEAN";

    footerTag.textContent =
      "SPECTRUM · " +
      theme.toUpperCase() +
      " · " +
      modeLabel +
      " · " +
      visualizerType.toUpperCase() +
      " · FX " +
      fxLabel +
      " · " +
      fxStrength.toUpperCase();
  }

  downloadPngBtn.addEventListener("click", () => {
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = "visualizer.png";
    link.click();
  });

  recordBtn.addEventListener("click", () => {
    alert("Recording to MP4/WebM is not fully implemented in this version yet.");
  });

  const PRESET_KEY = "dj_visualizer_preset_v1";

  savePresetBtn.addEventListener("click", () => {
    const preset = {
      theme,
      visualizerType,
      fxMode,
      fxStrength,
      visualizerEnabled,
      logoEnabled
    };
    localStorage.setItem(PRESET_KEY, JSON.stringify(preset));
    alert("Preset saved!");
  });

  loadPresetBtn.addEventListener("click", () => {
    const raw = localStorage.getItem(PRESET_KEY);
    if (!raw) {
      alert("No preset saved yet.");
      return;
    }
    try {
      const preset = JSON.parse(raw);
      theme = preset.theme || "neon";
      visualizerType = preset.visualizerType || "bars";
      fxMode = preset.fxMode || "none";
      fxStrength = preset.fxStrength || "soft";
      visualizerEnabled = !!preset.visualizerEnabled;
      logoEnabled = !!preset.logoEnabled;

      themeSelect.value = theme;
      visualizerSelect.value = visualizerType;
      fxSelect.value = fxMode === "glitch" ? "glitch" : "none";
      fxStrengthSelect.value = fxStrength;
      visualizerViewBtn.classList.toggle("active", visualizerEnabled);
      logoViewBtn.classList.toggle("active", logoEnabled);

      alert("Preset loaded.");
    } catch (err) {
      console.error(err);
      alert("Could not load preset.");
    }
  });

  function render() {
    requestAnimationFrame(render);
    drawBackground();

    if (visualizerEnabled && analyser && dataArray) {
      if (visualizerType === "bars") {
        drawBars();
      } else if (visualizerType === "circle") {
        drawCircle();
      } else {
        drawWaveform();
      }
    } else {
      if (analyser && dataArray) computeEnergy();
    }

    if (logoEnabled) {
      renderLogoFrame(ctx);
    }

    updateFooterTag();
  }

  resizeCanvas();
  render();
</script>
</body>
</html>
