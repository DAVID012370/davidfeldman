<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DJ Visualizer – Visual + Logo Views</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #141927, #050609 60%);
      color: #f7f7ff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 1.5rem;
    }

    .app-shell {
      width: 100%;
      max-width: 1100px;
      background: rgba(5, 7, 12, 0.95);
      border-radius: 24px;
      padding: 1.8rem 2rem 1.6rem;
      box-shadow:
        0 20px 80px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }

    .app-shell::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 10% 0%, rgba(0, 255, 178, 0.12), transparent 55%),
        radial-gradient(circle at 90% 0%, rgba(0, 194, 255, 0.12), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .app-shell > * {
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }

    .title-block h1 {
      font-size: 1.1rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      opacity: 0.95;
    }

    .title-block p {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-top: 0.2rem;
    }

    .view-toggle {
      display: inline-flex;
      border-radius: 999px;
      background: rgba(7, 11, 21, 0.9);
      padding: 0.16rem;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.08);
    }

    .view-toggle button {
      border: none;
      outline: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.7);
      padding: 0.28rem 0.9rem;
      border-radius: 999px;
      font-size: 0.78rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: 0.18s ease;
    }

    .view-toggle button.active {
      background: radial-gradient(circle at top, #00ffc6, #00b4ff);
      color: #020308;
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.12),
        0 0 18px rgba(0, 255, 200, 0.6);
    }

    .now-playing {
      margin-bottom: 0.4rem;
      text-align: center;
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .now-playing span {
      opacity: 0.7;
    }

    .visual-wrapper {
      margin-top: 0.1rem;
      border-radius: 24px;
      background: radial-gradient(circle at top, #141927, #050609 60%);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow:
        0 24px 80px rgba(0,0,0,0.8),
        0 0 0 1px rgba(255,255,255,0.06);
      padding: 1rem;
    }

    #dropZone {
      position: relative;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.08);
      overflow: hidden;
      cursor: pointer;
      background-color: #020308;
    }

    /* === CRT LOGO MODE (analog screen style) === */
    #dropZone.crt-logo {
      box-shadow:
        0 0 22px rgba(0, 255, 200, 0.18),
        0 0 42px rgba(0, 180, 255, 0.28);
      transform: perspective(900px) scale(1.01);
      transform-origin: center;
    }

    /* Barrel-like “screen” curvature on canvas in logo mode */
    #dropZone.crt-logo #visualCanvas {
      border-radius: 26px;
      transform: perspective(900px) translateZ(0) scale(1.03);
      transform-origin: center;
    }

    /* Vignette + scanlines overlay in logo mode */
    #dropZone.crt-logo::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-image:
        radial-gradient(ellipse at center,
          rgba(255, 255, 255, 0.08) 0%,
          transparent 40%,
          rgba(0, 0, 0, 0.35) 70%,
          rgba(0, 0, 0, 0.9) 100%
        ),
        repeating-linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.08) 0px,
          rgba(255, 255, 255, 0.08) 1px,
          transparent 1px,
          transparent 3px
        );
      mix-blend-mode: soft-light;
      opacity: 0.9;
    }

    /* Noise + flicker in logo mode */
    #dropZone.crt-logo::after {
      content: "";
      position: absolute;
      inset: -15%;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 160 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='noStitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.55'/%3E%3C/svg%3E");
      mix-blend-mode: screen;
      opacity: 0.18;
      animation: crtLogoFlicker 140ms steps(2, end) infinite;
    }

    @keyframes crtLogoFlicker {
      0%   { opacity: 0.24; transform: translate(0, 0); }
      45%  { opacity: 0.05; transform: translate(0.4px, -0.4px); }
      100% { opacity: 0.2;  transform: translate(-0.4px, 0.4px); }
    }

    /* RGB subpixel glow layer (only active in logo mode) */
    .crt-rgb-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0;
      mix-blend-mode: screen;
      transition: opacity 0.18s ease;
      z-index: 1;
    }

    #dropZone.crt-logo .crt-rgb-layer {
      opacity: 0.38;
      background-image: repeating-linear-gradient(
        to right,
        rgba(255, 0, 0, 0.16) 0px,
        rgba(255, 0, 0, 0.16) 1px,
        rgba(0, 255, 0, 0.16) 1px,
        rgba(0, 255, 0, 0.16) 2px,
        rgba(0, 0, 255, 0.16) 2px,
        rgba(0, 0, 255, 0.16) 3px,
        transparent 3px,
        transparent 4px
      );
      animation: crtRgbJitter 260ms steps(3, end) infinite;
    }

    @keyframes crtRgbJitter {
      0%   { transform: translate(0, 0); }
      33%  { transform: translate(0.3px, -0.3px); }
      66%  { transform: translate(-0.3px, 0.3px); }
      100% { transform: translate(0, 0); }
    }

    #visualCanvas {
      display: block;
      width: 100%;
      height: 440px;
      background: transparent;
      position: relative;
      z-index: 0;
    }

    .drop-hint {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.0;
      font-size: 0.85rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.7);
      pointer-events: none;
      transition: opacity 0.3s ease;
      text-align: center;
      padding: 0 1rem;
      z-index: 2;
    }

    #dropZone.drag-over .drop-hint {
      opacity: 0.8;
      backdrop-filter: blur(2px);
    }

    .footer-tag {
      position: absolute;
      right: 1.25rem;
      bottom: 0.9rem;
      font-size: 0.7rem;
      opacity: 0.7;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      z-index: 2;
    }

    .timeline-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 1rem;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .time-label {
      width: 2.5rem;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .timeline {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, #00ffc6, #00b4ff);
      outline: none;
    }

    .timeline::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #f7f7ff;
      border: 2px solid #00ffc6;
      box-shadow: 0 0 0 4px rgba(0, 255, 198, 0.25);
      cursor: pointer;
    }

    .timeline::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #f7f7ff;
      border: 2px solid #00ffc6;
      box-shadow: 0 0 0 4px rgba(0, 255, 198, 0.25);
      cursor: pointer;
    }

    .audio-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      font-size: 0.8rem;
    }

    .audio-buttons {
      display: flex;
      gap: 0.6rem;
      align-items: center;
    }

    .audio-buttons button {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(12, 18, 32, 0.9);
      color: #f7f7ff;
      padding: 0.35rem 0.9rem;
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: 0.18s ease;
    }

    .audio-buttons button.primary {
      background: radial-gradient(circle at top, #00ffc6, #00b4ff);
      color: #05080f;
      border-color: rgba(255, 255, 255, 0.7);
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.25),
        0 0 18px rgba(0, 255, 198, 0.75);
    }

    .audio-buttons button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.5);
    }

    .audio-info {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      opacity: 0.8;
    }

    .file-pill {
      border-radius: 999px;
      padding: 0.26rem 0.7rem;
      background: rgba(10, 18, 30, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.15);
      font-size: 0.72rem;
      max-width: 240px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .controls-row {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      margin-top: 1.1rem;
      font-size: 0.8rem;
    }

    .left-controls,
    .right-controls {
      display: flex;
      gap: 1.1rem;
      align-items: flex-start;
    }

    .left-controls > div,
    .right-controls > div {
      display: flex;
      flex-direction: column;
      gap: 0.18rem;
    }

    .control-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      opacity: 0.7;
    }

    select,
    input[type="range"].param-range {
      font-size: 0.8rem;
    }

    select {
      background: rgba(7, 12, 22, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: #f7f7ff;
      padding: 0.28rem 0.9rem;
      outline: none;
      min-width: 120px;
    }

    .param-range {
      -webkit-appearance: none;
      appearance: none;
      width: 140px;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, #00ffc6, #00b4ff);
      outline: none;
      margin-top: 0.32rem;
    }

    .param-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f7f7ff;
      border: 2px solid #00ffc6;
      box-shadow: 0 0 0 3px rgba(0, 255, 198, 0.2);
      cursor: pointer;
    }

    .param-range::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f7f7ff;
      border: 2px solid #00ffc6;
      box-shadow: 0 0 0 3px rgba(0, 255, 198, 0.2);
      cursor: pointer;
    }

    .chip-btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(7, 11, 20, 0.9);
      color: #f7f7ff;
      padding: 0.28rem 0.9rem;
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      cursor: pointer;
      transition: 0.18s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .chip-btn.secondary {
      background: rgba(3,7,14,0.9);
    }

    .chip-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.6);
    }

    .chip-btn.rec-on {
      background: radial-gradient(circle at top, #ff1744, #ff9100);
      box-shadow: 0 0 18px rgba(255, 23, 68, 0.7);
    }

    .logo-buttons {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.9rem;
    }

    .hidden-input {
      display: none;
    }

    @media (max-width: 768px) {
      .app-shell {
        padding: 1.3rem 1.2rem 1.2rem;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.8rem;
      }
      .controls-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .left-controls,
      .right-controls {
        width: 100%;
        justify-content: space-between;
      }
      .visual-wrapper {
        padding: 0.7rem;
      }
      #visualCanvas {
        height: 320px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="title-block">
        <h1>DJ VISUALIZER</h1>
        <p>Audio reactive visuals · enjoy : )</p>
      </div>
      <div class="view-toggle">
        <button class="pill-toggle active" id="visualizerViewBtn">Visualizer</button>
        <button class="pill-toggle" id="logoViewBtn">Logo</button>
      </div>
    </header>

    <div class="now-playing" id="nowPlaying">
      <span>Now Playing:</span> — none —
    </div>

    <div class="controls-row">
      <div class="left-controls">
        <div>
          <label class="control-label" for="themeSelect">Theme</label><br />
          <select id="themeSelect">
            <option value="neon">Neon</option>
            <option value="midnight">Midnight</option>
            <option value="sunset">Sunset</option>
          </select>
        </div>

        <div>
          <label class="control-label" for="visualizerSelect">Visualizer</label><br />
          <select id="visualizerSelect">
            <option value="bars">Bars</option>
            <option value="circle">Circle</option>
            <option value="wave">Waveform</option>
          </select>
        </div>
      </div>

      <div class="right-controls">
        <div>
          <label class="control-label" for="fxSelect">FX Mode</label><br />
          <select id="fxSelect">
            <option value="none">Clean</option>
            <option value="glitch">Glitch</option>
          </select>
          <input
            type="range"
            min="0"
            max="100"
            value="40"
            class="param-range"
            id="fxStrengthRange"
          />
        </div>

        <div>
          <label class="control-label">Export</label><br />
          <div style="display:flex; gap:0.4rem;">
            <button class="chip-btn" id="downloadPngBtn">DL PNG</button>
            <button class="chip-btn secondary" id="recordBtn">REC</button>
            <button class="chip-btn secondary" id="savePresetBtn">SAVE</button>
            <button class="chip-btn secondary" id="loadPresetBtn">LOAD</button>
          </div>
        </div>
      </div>
    </div>

    <div class="controls-row" style="margin-top:0.8rem;">
      <div class="left-controls">
        <div>
          <label class="control-label" for="glitchTilesRange">Glitch Tiles</label>
          <input
            type="range"
            min="4"
            max="32"
            value="12"
            class="param-range"
            id="glitchTilesRange"
          />
        </div>
        <div>
          <label class="control-label" for="glitchAngleSelect">Glitch Angle</label>
          <select id="glitchAngleSelect">
            <option value="normal">Normal</option>
            <option value="soft">Soft</option>
            <option value="wild">Wild</option>
          </select>
        </div>
      </div>

      <div class="right-controls">
        <div>
          <label class="control-label">Logo Controls</label>
          <div class="logo-buttons">
            <button class="chip-btn secondary" id="logoUploadBtn">Logo</button>
            <button class="chip-btn secondary" id="logoClearBtn">Logo X</button>
          </div>
        </div>
      </div>
    </div>

    <div class="visual-wrapper">
      <div id="dropZone">
        <canvas id="visualCanvas"></canvas>
        <!-- RGB subpixel overlay layer -->
        <div class="crt-rgb-layer"></div>

        <div class="drop-hint">
          Drag & drop audio or logo here.
        </div>
        <div class="footer-tag" id="footerTag">
          SPECTRUM · NEON · BARS · CLEAN
        </div>
      </div>
    </div>

    <div class="timeline-row">
      <div class="time-label" id="currentTimeLabel">0:00</div>
      <input type="range" min="0" max="100" value="0" class="timeline" id="timelineRange" />
      <div class="time-label" id="durationLabel">0:00</div>
    </div>

    <div class="audio-row">
      <div class="audio-buttons">
        <button id="loadTrackBtn">Load Track</button>
        <button class="primary" id="playPauseBtn">Play</button>
        <button id="clearAudioBtn" class="secondary">Clear</button>
      </div>
      <div class="audio-info">
        <span>File:</span>
        <span class="file-pill" id="fileNamePill">None</span>
      </div>
    </div>

    <audio id="audioElement" class="hidden-input" controls></audio>

    <input type="file" id="audioInput" class="hidden-input" accept="audio/*" />
    <input type="file" id="logoInput" class="hidden-input" accept="image/*" />

    <script>
      const canvas = document.getElementById("visualCanvas");
      const ctx = canvas.getContext("2d");
      const dropZone = document.getElementById("dropZone");

      const themeSelect = document.getElementById("themeSelect");
      const visualizerSelect = document.getElementById("visualizerSelect");
      const fxSelect = document.getElementById("fxSelect");
      const fxStrengthRange = document.getElementById("fxStrengthRange");
      const glitchTilesRange = document.getElementById("glitchTilesRange");
      const glitchAngleSelect = document.getElementById("glitchAngleSelect");

      const visualizerViewBtn = document.getElementById("visualizerViewBtn");
      const logoViewBtn = document.getElementById("logoViewBtn");

      const loadTrackBtn = document.getElementById("loadTrackBtn");
      const playPauseBtn = document.getElementById("playPauseBtn");
      const clearAudioBtn = document.getElementById("clearAudioBtn");
      const fileNamePill = document.getElementById("fileNamePill");
      const audioEl = document.getElementById("audioElement");
      const audioInput = document.getElementById("audioInput");

      const logoInput = document.getElementById("logoInput");
      const logoUploadBtn = document.getElementById("logoUploadBtn");
      const logoClearBtn = document.getElementById("logoClearBtn");

      const downloadPngBtn = document.getElementById("downloadPngBtn");
      const recordBtn = document.getElementById("recordBtn");
      const savePresetBtn = document.getElementById("savePresetBtn");
      const loadPresetBtn = document.getElementById("loadPresetBtn");

      const nowPlayingEl = document.getElementById("nowPlaying");
      const currentTimeLabel = document.getElementById("currentTimeLabel");
      const durationLabel = document.getElementById("durationLabel");
      const timelineRange = document.getElementById("timelineRange");

      let theme = "neon";
      let visualizerType = "bars";
      let fxMode = "none";
      let fxStrength = "soft";
      let glitchAngleMode = "normal";

      let visualizerEnabled = true;
      let logoEnabled = false;

      let audioLoaded = false;
      let analyser = null;
      let dataArray = null;
      let sourceNode = null;
      let audioCtx = null;

      let canvasDisplayWidth = 960;
      let canvasDisplayHeight = 440;

      let logoImage = null;
      let logoLoaded = false;

      let logoBuffer = document.createElement("canvas");
      let logoBufferCtx = logoBuffer.getContext("2d");

      let lastAudioFile = null;
      let lastAudioFileName = "";

      function setupAudioAnalyser() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (sourceNode) {
          sourceNode.disconnect();
        }
        sourceNode = audioCtx.createMediaElementSource(audioEl);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 1024;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        sourceNode.connect(analyser);
        analyser.connect(audioCtx.destination);
      }

      function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        canvasDisplayWidth = rect.width;
        canvasDisplayHeight = 440;

        const dpr = window.devicePixelRatio || 1;
        canvas.width = canvasDisplayWidth * dpr;
        canvas.height = canvasDisplayHeight * dpr;
        canvas.style.height = canvasDisplayHeight + "px";
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }

      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      function drawBackground() {
        const w = canvasDisplayWidth;
        const h = canvasDisplayHeight;
        const g = ctx.createRadialGradient(
          w / 2,
          h * 0.1,
          0,
          w / 2,
          h / 2,
          Math.max(w, h)
        );

        if (theme === "neon") {
          g.addColorStop(0, "#1b2145");
          g.addColorStop(0.5, "#060712");
          g.addColorStop(1, "#020308");
        } else if (theme === "midnight") {
          g.addColorStop(0, "#101826");
          g.addColorStop(0.5, "#05060b");
          g.addColorStop(1, "#010205");
        } else {
          g.addColorStop(0, "#431b45");
          g.addColorStop(0.5, "#120606");
          g.addColorStop(1, "#060103");
        }

        ctx.fillStyle = g;
        ctx.fillRect(0, 0, w, h);

        ctx.save();
        ctx.globalAlpha = 0.16;
        const stripeH = 22;
        for (let y = 0; y < h; y += stripeH) {
          ctx.fillStyle = y % (stripeH * 2) === 0
            ? "rgba(255,255,255,0.08)"
            : "rgba(0,0,0,0.35)";
          ctx.fillRect(0, y, w, 12);
        }
        ctx.restore();
      }

      function drawBars() {
        if (!analyser || !dataArray) return;
        analyser.getByteFrequencyData(dataArray);

        const w = canvasDisplayWidth;
        const h = canvasDisplayHeight;
        const barCount = 80;
        const barWidth = w / barCount;
        const centerY = h * 0.55;

        for (let i = 0; i < barCount; i++) {
          const idx = Math.floor((i / barCount) * dataArray.length);
          const value = dataArray[idx] / 255;
          const barHeight = 40 + value * (h * 0.5);

          const x = i * barWidth;

          const baseHue = theme === "sunset" ? 22 : theme === "midnight" ? 210 : 165;
          const hue = baseHue + value * 40;
          const sat = 80 + value * 20;
          const light = 50 + value * 10;

          ctx.fillStyle = `hsla(${hue}, ${sat}%, ${light}%, 0.85)`;
          const topY = centerY - barHeight / 2;
          ctx.fillRect(x, topY, barWidth * 0.8, barHeight);

          ctx.fillStyle = `hsla(${hue + 40}, 100%, 75%, 0.9)`;
          ctx.fillRect(x, topY, barWidth * 0.8, 4);
        }
      }

      function drawCircleVisualizer() {
        if (!analyser || !dataArray) return;
        analyser.getByteFrequencyData(dataArray);

        const w = canvasDisplayWidth;
        const h = canvasDisplayHeight;
        const cx = w / 2;
        const cy = h / 2;
        const radius = Math.min(w, h) * 0.22;

        ctx.save();
        ctx.translate(cx, cy);

        const length = dataArray.length;
        for (let i = 0; i < length; i++) {
          const value = dataArray[i] / 255;
          const angle = (i / length) * Math.PI * 2;

          const inner = radius * (0.75 + value * 0.25);
          const outer = radius * (1.4 + value * 0.9);

          const x1 = Math.cos(angle) * inner;
          const y1 = Math.sin(angle) * inner;
          const x2 = Math.cos(angle) * outer;
          const y2 = Math.sin(angle) * outer;

          const baseHue = theme === "sunset" ? 32 : theme === "midnight" ? 210 : 165;
          const hue = baseHue + value * 90;
          const sat = 80 + value * 20;
          const light = 50 + value * 15;
          ctx.strokeStyle = `hsla(${hue}, ${sat}%, ${light}%, 0.9)`;
          ctx.lineWidth = 2 + value * 3;

          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();
        }

        ctx.restore();
      }

      function drawWaveform() {
        if (!analyser || !dataArray) return;

        analyser.getByteTimeDomainData(dataArray);
        const w = canvasDisplayWidth;
        const h = canvasDisplayHeight;
        const centerY = h * 0.5;

        ctx.save();
        ctx.beginPath();
        ctx.lineWidth = 2;
        const baseHue = theme === "sunset" ? 25 : theme === "midnight" ? 210 : 170;
        ctx.strokeStyle = `hsla(${baseHue}, 90%, 70%, 0.9)`;

        for (let i = 0; i < dataArray.length; i++) {
          const v = dataArray[i] / 128.0 - 1.0;
          const x = (i / (dataArray.length - 1)) * w;
          const y = centerY + v * (h * 0.3);

          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }

        ctx.stroke();
        ctx.restore();
      }

      function drawGlitch(mainCtx) {
        const w = canvasDisplayWidth;
        const h = canvasDisplayHeight;

        const strength = fxStrength === "soft" ? 0.3 : fxStrength === "hard" ? 1.0 : 0.6;
        const tiles = parseInt(glitchTilesRange.value, 10) || 12;
        const tileSize = Math.max(8, Math.floor(w / tiles));

        const tilesX = Math.floor(w / tileSize);
        const tilesY = Math.floor(h / tileSize);

        const baseCount = 4 + Math.floor(strength * 11);
        const glitchCount = baseCount;
        const maxAngle = getAngleFactor() * (Math.PI / 18) * strength;

        const baseFlipChance = 0.05 + strength * 0.25;

        for (let i = 0; i < glitchCount; i++) {
          const sxIndex = Math.floor(Math.random() * tilesX);
          const syIndex = Math.floor(Math.random() * tilesY);

          const sx = sxIndex * tileSize;
          const sy = syIndex * tileSize;
          const sw = tileSize;
          const sh = tileSize;

          const sample = mainCtx.getImageData(sx, sy, sw, sh);
          let sum = 0;
          for (let j = 0; j < sample.data.length; j += 4) {
            sum += sample.data[j] + sample.data[j + 1] + sample.data[j + 2];
          }
          const avg = sum / (sample.data.length / 4) / 255;
          if (avg < 0.05) continue;

          const maxOffset = tileSize * (0.12 + 0.28 * strength);
          const offsetX = (Math.random() - 0.5) * maxOffset;
          const offsetY = (Math.random() - 0.5) * maxOffset * 0.6;

          const angle = (Math.random() - 0.5) * maxAngle;

          const dx = sx + offsetX;
          const dy = sy + offsetY;

          mainCtx.save();
          mainCtx.translate(dx + sw / 2, dy + sh / 2);
          mainCtx.rotate(angle);

          const flipRand = Math.random();
          let drawW = sw;
          let drawH = sh;

          if (flipRand < baseFlipChance) {
            drawW = -sw;
          } else if (flipRand < baseFlipChance * 2) {
            drawH = -sh;
          }

          const uOffset = (Math.random() - 0.5) * 0.08 * sw;
          const vOffset = (Math.random() - 0.5) * 0.08 * sh;

          mainCtx.drawImage(
            canvas,
            sx,
            sy,
            sw,
            sh,
            -sw / 2 + uOffset,
            -sh / 2 + vOffset,
            drawW,
            drawH
          );

          mainCtx.restore();
        }
      }

      function renderLogoFrame(mainCtx) {
        if (!logoLoaded || !logoImage) return;

        const w = canvasDisplayWidth;
        const h = canvasDisplayHeight;

        logoBuffer.width = w;
        logoBuffer.height = h;
        logoBufferCtx.clearRect(0, 0, w, h);

        const maxW = w * 0.55;
        const maxH = h * 0.55;
        const ratio = logoImage.width / logoImage.height;
        let drawW = maxW;
        let drawH = drawW / ratio;
        if (drawH > maxH) {
          drawH = maxH;
          drawW = drawH * ratio;
        }
        const logoX = (w - drawW) / 2;
        const logoY = (h - drawH) / 2;

        logoBufferCtx.drawImage(logoImage, logoX, logoY, drawW, drawH);

        mainCtx.save();
        mainCtx.globalAlpha = 0.95;
        mainCtx.drawImage(logoBuffer, 0, 0);
        mainCtx.restore();
      }

      function clamp(v, min, max) {
        return Math.min(max, Math.max(min, v));
      }

      function getAngleFactor() {
        switch (glitchAngleMode) {
          case "soft":
            return 0.5;
          case "wild":
            return 1.4;
          case "normal":
          default:
            return 1.0;
        }
      }

      function formatTime(sec) {
        if (!isFinite(sec)) return "0:00";
        const m = Math.floor(sec / 60);
        const s = Math.floor(sec % 60);
        return m + ":" + (s < 10 ? "0" + s : s);
      }

      function updateNowPlaying(name) {
        nowPlayingEl.innerHTML = '<span>Now Playing:</span> ' + (name || "— none —");
      }

      function loadAudioFile(file) {
        if (!file) return;
        const url = URL.createObjectURL(file);
        audioEl.src = url;
        audioEl.load();
        audioLoaded = true;
        lastAudioFile = file;
        lastAudioFileName = file.name || "track";
        fileNamePill.textContent = lastAudioFileName;
        updateNowPlaying(lastAudioFileName);
        playPauseBtn.textContent = "Play";
      }

      loadTrackBtn.addEventListener("click", () => {
        audioInput.click();
      });

      audioInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        loadAudioFile(file);
      });

      clearAudioBtn.addEventListener("click", () => {
        audioEl.pause();
        audioEl.src = "";
        audioLoaded = false;
        lastAudioFile = null;
        lastAudioFileName = "";
        fileNamePill.textContent = "None";
        updateNowPlaying("— none —");
      });

      audioEl.addEventListener("play", () => {
        if (!audioCtx) setupAudioAnalyser();
        if (audioCtx && audioCtx.state === "suspended") {
          audioCtx.resume();
        }
      });

      audioEl.addEventListener("timeupdate", () => {
        if (!audioEl.duration) return;
        const ratio = audioEl.currentTime / audioEl.duration;
        timelineRange.value = clamp(ratio * 100, 0, 100);
        currentTimeLabel.textContent = formatTime(audioEl.currentTime);
        durationLabel.textContent = formatTime(audioEl.duration);
      });

      timelineRange.addEventListener("input", () => {
        if (!audioEl.duration) return;
        const ratio = timelineRange.value / 100;
        audioEl.currentTime = audioEl.duration * ratio;
      });

      playPauseBtn.addEventListener("click", () => {
        if (!audioLoaded) {
          audioInput.click();
          return;
        }
        if (audioEl.paused) {
          audioEl.play();
          playPauseBtn.textContent = "Pause";
        } else {
          audioEl.pause();
          playPauseBtn.textContent = "Play";
        }
      });

      audioEl.addEventListener("ended", () => {
        playPauseBtn.textContent = "Play";
      });

      logoUploadBtn.addEventListener("click", () => {
        logoInput.click();
      });

      logoInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => {
          logoImage = img;
          logoLoaded = true;
        };
        img.src = url;
      });

      logoClearBtn.addEventListener("click", () => {
        logoImage = null;
        logoLoaded = false;
      });

      const PRESET_KEY = "dj_visualizer_preset_v1";

      savePresetBtn.addEventListener("click", () => {
        const preset = {
          theme,
          visualizerType,
          fxMode,
          fxStrength,
          visualizerEnabled,
          logoEnabled
        };
        localStorage.setItem(PRESET_KEY, JSON.stringify(preset));
        alert("Preset saved.");
      });

      loadPresetBtn.addEventListener("click", () => {
        const raw = localStorage.getItem(PRESET_KEY);
        if (!raw) {
          alert("No preset saved yet.");
          return;
        }
        try {
          const preset = JSON.parse(raw);
          theme = preset.theme || "neon";
          visualizerType = preset.visualizerType || "bars";
          fxMode = preset.fxMode || "none";
          fxStrength = preset.fxStrength || "soft";
          visualizerEnabled = !!preset.visualizerEnabled;
          logoEnabled = !!preset.logoEnabled;

          themeSelect.value = theme;
          visualizerSelect.value = visualizerType;
          fxSelect.value = fxMode === "glitch" ? "glitch" : "none";

          if (fxStrength === "soft") fxStrengthRange.value = 20;
          else if (fxStrength === "hard") fxStrengthRange.value = 80;
          else fxStrengthRange.value = 50;

          visualizerViewBtn.classList.toggle("active", visualizerEnabled);
          logoViewBtn.classList.toggle("active", logoEnabled);
          dropZone.classList.toggle("crt-logo", logoEnabled);

          alert("Preset loaded.");
        } catch (err) {
          console.error(err);
          alert("Could not load preset.");
        }
      });

      function render() {
        requestAnimationFrame(render);
        drawBackground();

        if (visualizerEnabled && analyser && dataArray) {
          if (visualizerType === "bars") {
            drawBars();
          } else if (visualizerType === "circle") {
            drawCircleVisualizer();
          } else if (visualizerType === "wave") {
            drawWaveform();
          }
        }

        if (fxMode === "glitch") {
          drawGlitch(ctx);
        }

        if (logoEnabled) {
          renderLogoFrame(ctx);
        }
      }

      themeSelect.addEventListener("change", () => {
        theme = themeSelect.value;
      });

      visualizerSelect.addEventListener("change", () => {
        visualizerType = visualizerSelect.value;
      });

      fxSelect.addEventListener("change", () => {
        fxMode = fxSelect.value;
      });

      fxStrengthRange.addEventListener("input", () => {
        const v = parseInt(fxStrengthRange.value, 10);
        if (v <= 33) fxStrength = "soft";
        else if (v >= 67) fxStrength = "hard";
        else fxStrength = "medium";
      });

      glitchAngleSelect.addEventListener("change", () => {
        glitchAngleMode = glitchAngleSelect.value;
      });

      visualizerViewBtn.addEventListener("click", () => {
        visualizerEnabled = !visualizerEnabled;
        visualizerViewBtn.classList.toggle("active", visualizerEnabled);
      });

      logoViewBtn.addEventListener("click", () => {
        logoEnabled = !logoEnabled;
        logoViewBtn.classList.toggle("active", logoEnabled);
        dropZone.classList.toggle("crt-logo", logoEnabled);
      });

      // CLICK ON SCREEN:
      // - In Visualizer mode: open audio picker
      // - In Logo mode: open logo picker
      dropZone.addEventListener("click", () => {
        if (logoEnabled) {
          logoInput.click();
        } else {
          audioInput.click();
        }
      });

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("drag-over");
        if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("drag-over");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("drag-over");
        const files = e.dataTransfer.files;
        if (!files || !files.length) return;

        const file = files[0];
        if (file.type.startsWith("audio/")) {
          loadAudioFile(file);
        } else if (file.type.startsWith("image/")) {
          const url = URL.createObjectURL(file);
          const img = new Image();
          img.onload = () => {
            logoImage = img;
            logoLoaded = true;
          };
          img.src = url;
        }
      });

      resizeCanvas();
      render();
    </script>
  </div>
</body>
</html>
