<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DJ Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #141927, #050609 60%);
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    body.drag-over .visualizer-wrapper {
      outline: 2px dashed rgba(255, 255, 255, 0.4);
      background: radial-gradient(circle at center, #181b33, #020307 75%);
    }

    .app {
      width: 100%;
      max-width: 1200px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .brand-title {
      font-size: 1.4rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .brand-sub {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .file-input-label {
      position: relative;
      overflow: hidden;
      border-radius: 999px;
      padding: 0.6rem 1.2rem;
      font-size: 0.85rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(12px);
      cursor: pointer;
      transition: background 0.2s, transform 0.1s, border-color 0.2s;
      white-space: nowrap;
    }

    .file-input-label:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .file-input-label:active {
      transform: scale(0.97);
    }

    .file-input-label input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.6rem 1.1rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: linear-gradient(135deg, #f72585, #7209b7);
      color: white;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      box-shadow: 0 0 20px rgba(247, 37, 133, 0.4);
      opacity: 0.85;
      transition: opacity 0.15s, transform 0.1s, box-shadow 0.2s;
      white-space: nowrap;
    }

    button:hover {
      opacity: 1;
      box-shadow: 0 0 30px rgba(247, 37, 133, 0.7);
    }

    button:active {
      transform: scale(0.97);
    }

    button:disabled {
      opacity: 0.3;
      cursor: default;
      box-shadow: none;
    }

    #clearTrack {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.35);
      padding: 0.45rem 0.8rem;
      color: #fff;
      opacity: 0.6;
      box-shadow: none;
      font-weight: 500;
    }

    #clearTrack:hover {
      opacity: 1;
      border-color: rgba(255, 255, 255, 0.7);
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.25);
    }

    #fullscreenBtn,
    #performBtn {
      padding: 0.45rem 0.8rem;
      font-size: 0.8rem;
    }

    .status-row {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .status {
      font-size: 0.78rem;
      opacity: 0.7;
    }

    .seek-container {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.1rem;
    }

    .seek-time {
      font-size: 0.72rem;
      opacity: 0.7;
      min-width: 3.3rem;
      text-align: center;
      direction: ltr;
    }

    .seek-bar {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.15);
      outline: none;
      cursor: pointer;
    }

    .seek-bar:disabled {
      opacity: 0.35;
      cursor: default;
    }

    .seek-bar::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f72585;
      box-shadow: 0 0 8px rgba(247, 37, 133, 0.7);
      border: none;
      margin-top: -4px;
    }

    .seek-bar::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f72585;
      box-shadow: 0 0 8px rgba(247, 37, 133, 0.7);
      border: none;
    }

    .seek-bar::-moz-range-track {
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.15);
    }

    .volume-wrapper {
      display: flex;
      align-items: center;
      padding: 0 0.3rem;
    }

    .volume-slider {
      width: 70px;
      height: 4px;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 999px;
      outline: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4cc9f0;
      box-shadow: 0 0 8px #4cc9f0;
    }

    .volume-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4cc9f0;
      box-shadow: 0 0 8px #4cc9f0;
      border: none;
    }

    .select-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .select-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.7;
    }

    .select-control {
      font-size: 0.8rem;
      padding: 0.45rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(4, 4, 10, 0.8);
      color: #f5f5f5;
      outline: none;
      cursor: pointer;
      backdrop-filter: blur(10px);
    }

    .select-control:focus {
      border-color: rgba(255, 255, 255, 0.6);
    }

    .visualizer-wrapper {
      flex: 1;
      border-radius: 1.5rem;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: radial-gradient(circle at center, #111322, #020307 70%);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      height: 65vh;
    }

    .visualizer-inner {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #visualizer {
      display: block;
    }

    .watermark {
      position: absolute;
      bottom: 0.9rem;
      right: 1.3rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      opacity: 0.45;
    }

    /* ---------- PERFORMANCE MODE ---------- */

    body.perform-mode header,
    body.perform-mode .status-row {
      display: none;
    }

    body.perform-mode .app {
      max-width: 100%;
      padding: 0;
      gap: 0;
    }

    body.perform-mode .visualizer-wrapper {
      height: 100vh;
      border-radius: 0;
      border: none;
    }

    body.perform-mode .watermark {
      opacity: 0.25;
      font-size: 0.6rem;
    }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <div class="brand">
        <div class="brand-title">DJ VISUALIZER</div>
        <div class="brand-sub">Audio reactive visuals Â· XP vibes soon</div>
      </div>

      <div class="controls">
        <div class="select-wrapper">
          <span class="select-label">Theme</span>
          <select id="themeSelect" class="select-control">
            <option value="neon">Neon</option>
            <option value="xp">XP Blue</option>
            <option value="vapor">Vaporwave</option>
            <option value="minimal">Minimal</option>
          </select>
        </div>

        <div class="select-wrapper">
          <span class="select-label">Visualizer</span>
          <select id="visualizerSelect" class="select-control">
            <option value="bars">Bars</option>
            <option value="circle">Circle</option>
            <option value="wave">Waveform</option>
          </select>
        </div>

        <label class="file-input-label">
          Load Track
          <input id="audioFile" type="file" accept="audio/*" />
        </label>
        <button id="playPause" disabled>Play</button>

        <div class="volume-wrapper">
          <input
            id="volumeSlider"
            type="range"
            min="0"
            max="1"
            step="0.01"
            value="1"
            class="volume-slider"
          />
        </div>

        <button id="clearTrack" title="Clear current track">âœ•</button>
        <button id="downloadAudio" title="Download audio file" disabled>DL Audio</button>
        <button id="downloadFrame" title="Download visualizer frame">DL PNG</button>
        <button id="fullscreenBtn" title="Toggle fullscreen">â›¶</button>
        <button id="performBtn" title="Toggle clean performance view">PERF</button>
      </div>
    </header>

    <div class="status-row">
      <div class="status" id="statusText">
        Load an audio file to start. You can also drag &amp; drop an MP3/WAV here.
      </div>
      <div class="seek-container">
        <span class="seek-time" id="currentTime">0:00</span>
        <input
          type="range"
          id="seekBar"
          class="seek-bar"
          min="0"
          value="0"
          step="0.01"
          disabled
        />
        <span class="seek-time" id="durationTime">0:00</span>
      </div>
      <div class="status">
        ðŸ’¡ Tip: You can drag a music file from anywhere onto the visualizer area.  
        Space = Play/Pause Â· P = Performance
      </div>
    </div>

    <section class="visualizer-wrapper">
      <div class="visualizer-inner">
        <canvas id="visualizer"></canvas>
      </div>
      <div class="watermark" id="watermarkText">Spectrum Â· v1.4 Â· Download Ready</div>
    </section>
  </main>

  <script>
    const fileInput = document.getElementById("audioFile");
    const playPauseBtn = document.getElementById("playPause");
    const statusText = document.getElementById("statusText");
    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");
    const visualizerWrapper = document.querySelector(".visualizer-wrapper");

    const seekBar = document.getElementById("seekBar");
    const currentTimeLabel = document.getElementById("currentTime");
    const durationTimeLabel = document.getElementById("durationTime");
    const volumeSlider = document.getElementById("volumeSlider");
    const clearTrackBtn = document.getElementById("clearTrack");
    const fullscreenBtn = document.getElementById("fullscreenBtn");
    const performBtn = document.getElementById("performBtn");
    const themeSelect = document.getElementById("themeSelect");
    const visualizerSelect = document.getElementById("visualizerSelect");
    const watermarkText = document.getElementById("watermarkText");
    const downloadAudioBtn = document.getElementById("downloadAudio");
    const downloadFrameBtn = document.getElementById("downloadFrame");

    let audioContext;
    let audioSource;
    let analyser;
    let dataArray;
    let waveArray;
    let audioElement = null;
    let isPlaying = false;
    let animationId;
    let isSeeking = false;

    let currentFile = null;
    let currentFileUrl = null;

    const themes = {
      neon: {
        bodyBg: "radial-gradient(circle at top, #141927, #050609 60%)",
        visBg: "radial-gradient(circle at center, #111322, #020307 70%)",
        barColors: ["#4cc9f0", "#f72585", "#b5179e"],
        watermark: "Spectrum Â· v1.4 Â· Neon"
      },
      xp: {
        bodyBg: "radial-gradient(circle at top, #1b3b73, #020b1f 70%)",
        visBg: "radial-gradient(circle at center, #0b2c6a, #020716 75%)",
        barColors: ["#8fd3ff", "#ffffff", "#4a90e2"],
        watermark: "Spectrum Â· XP mode"
      },
      vapor: {
        bodyBg: "linear-gradient(135deg, #ff9a9e 0%, #fad0c4 50%, #a1c4fd 100%)",
        visBg: "radial-gradient(circle at center, rgba(10,10,25,0.95), rgba(4,4,12,0.98))",
        barColors: ["#ff9a9e", "#fecdff", "#a1c4fd"],
        watermark: "Spectrum Â· Vaporwave"
      },
      minimal: {
        bodyBg: "linear-gradient(135deg, #111111, #222222)",
        visBg: "radial-gradient(circle at center, #050505, #101010 80%)",
        barColors: ["#ffffff", "#cccccc", "#999999"],
        watermark: "Spectrum Â· Minimal"
      }
    };

    let currentThemeKey = "neon";
    let currentVisualizer = "bars";

    function applyTheme(themeKey) {
      const theme = themes[themeKey] || themes.neon;
      currentThemeKey = themeKey;
      document.body.style.background = theme.bodyBg;
      visualizerWrapper.style.background = theme.visBg;
      updateWatermark();
    }

    function updateWatermark() {
      const theme = themes[currentThemeKey] || themes.neon;
      if (watermarkText) {
        watermarkText.textContent =
          theme.watermark + " Â· " + currentVisualizer.toUpperCase();
      }
    }

    themeSelect.addEventListener("change", (e) => {
      applyTheme(e.target.value);
    });

    visualizerSelect.addEventListener("change", (e) => {
      currentVisualizer = e.target.value;
      updateWatermark();
    });

    function resizeCanvas() {
      const rect = visualizerWrapper.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    window.addEventListener("resize", resizeCanvas);

    function initAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        waveArray = new Uint8Array(bufferLength);
      }
    }

    function formatTime(sec) {
      if (!isFinite(sec)) return "0:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60)
        .toString()
        .padStart(2, "0");
      return `${m}:${s}`;
    }

    function stopVisualizer() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    function resetUIToEmpty() {
      playPauseBtn.disabled = true;
      playPauseBtn.textContent = "Play";
      seekBar.disabled = true;
      seekBar.value = 0;
      currentTimeLabel.textContent = "0:00";
      durationTimeLabel.textContent = "0:00";
      downloadAudioBtn.disabled = true;
      statusText.textContent =
        "Load an audio file to start. You can also drag & drop an MP3/WAV here.";
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function loadAudioFile(file) {
      if (!file) return;
      if (!file.type.startsWith("audio/")) {
        statusText.textContent =
          "This file is not an audio file. Please use an MP3 or WAV track.";
        return;
      }

      if (audioElement) {
        audioElement.pause();
      }
      if (audioSource) {
        try {
          audioSource.disconnect();
        } catch (e) {}
      }
      stopVisualizer();

      // × ×™×”×•×œ ×”-blob ×©×œ ×”×§×•×‘×¥ ×‘×©×‘×™×œ ×”×•×¨×“×”
      if (currentFileUrl) {
        URL.revokeObjectURL(currentFileUrl);
      }
      currentFile = file;
      currentFileUrl = URL.createObjectURL(file);

      initAudioContext();

      audioElement = new Audio(currentFileUrl);
      audioElement.crossOrigin = "anonymous";
      audioElement.loop = true;
      audioElement.volume = Number(volumeSlider.value || 1);

      audioSource = audioContext.createMediaElementSource(audioElement);
      audioSource.connect(analyser);
      analyser.connect(audioContext.destination);

      seekBar.disabled = true;
      seekBar.value = 0;
      currentTimeLabel.textContent = "0:00";
      durationTimeLabel.textContent = "0:00";

      audioElement.addEventListener("loadedmetadata", () => {
        seekBar.max = audioElement.duration || 0;
        seekBar.disabled = false;
        durationTimeLabel.textContent = formatTime(audioElement.duration);
      });

      audioElement.addEventListener("timeupdate", () => {
        if (!isSeeking) {
          seekBar.value = audioElement.currentTime || 0;
          currentTimeLabel.textContent = formatTime(audioElement.currentTime);
        }
      });

      playPauseBtn.disabled = false;
      playPauseBtn.textContent = "Play";
      downloadAudioBtn.disabled = false;
      isPlaying = false;
      statusText.textContent = `Loaded: ${file.name}`;
    }

    fileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      loadAudioFile(file);
      event.target.value = "";
    });

    async function togglePlayPause() {
      if (!audioElement) return;

      if (!isPlaying) {
        if (audioContext.state === "suspended") {
          await audioContext.resume();
        }
        await audioElement.play();
        isPlaying = true;
        playPauseBtn.textContent = "Pause";
        statusText.textContent = "Playing Â· Visualizer active";
        startVisualizer();
      } else {
        audioElement.pause();
        isPlaying = false;
        playPauseBtn.textContent = "Play";
        statusText.textContent = "Paused";
        stopVisualizer();
      }
    }

    playPauseBtn.addEventListener("click", async () => {
      await togglePlayPause();
    });

    volumeSlider.addEventListener("input", () => {
      if (audioElement) {
        audioElement.volume = Number(volumeSlider.value);
      }
    });

    clearTrackBtn.addEventListener("click", () => {
      if (audioElement) {
        audioElement.pause();
      }
      if (audioSource) {
        try {
          audioSource.disconnect();
        } catch (e) {}
      }
      if (currentFileUrl) {
        URL.revokeObjectURL(currentFileUrl);
        currentFileUrl = null;
      }
      currentFile = null;
      audioElement = null;
      isPlaying = false;
      stopVisualizer();
      resetUIToEmpty();
    });

    // ×”×•×¨×“×ª ×”××•×“×™×•
    downloadAudioBtn.addEventListener("click", () => {
      if (!currentFile || !currentFileUrl) return;
      const a = document.createElement("a");
      a.href = currentFileUrl;
      a.download = currentFile.name || "track.wav";
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // ×”×•×¨×“×ª ×¤×¨×™×™× ×”×•×•×™×–×•××œ×™×™×–×¨ ×›-PNG
    downloadFrameBtn.addEventListener("click", () => {
      canvas.toBlob((blob) => {
        if (!blob) return;
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const ts = new Date().toISOString().replace(/[:.]/g, "-");
        a.href = url;
        a.download = `visualizer-${ts}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }, "image/png");
    });

    // Fullscreen
    fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        if (visualizerWrapper.requestFullscreen) {
          visualizerWrapper.requestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    });

    document.addEventListener("fullscreenchange", () => {
      const isFullscreen = !!document.fullscreenElement;
      fullscreenBtn.textContent = isFullscreen ? "â¤¢" : "â›¶";
      resizeCanvas();
    });

    // Keyboard shortcuts: SPACE = play/pause, P = performance mode
    document.addEventListener("keydown", async (e) => {
      if (e.code === "Space") {
        e.preventDefault();
        await togglePlayPause();
        return;
      }

      if (e.key === "p" || e.key === "P") {
        document.body.classList.toggle("perform-mode");
        resizeCanvas();
      }
    });

    seekBar.addEventListener("input", () => {
      if (!audioElement) return;
      isSeeking = true;
      currentTimeLabel.textContent = formatTime(seekBar.value);
    });

    seekBar.addEventListener("change", () => {
      if (!audioElement) return;
      audioElement.currentTime = Number(seekBar.value) || 0;
      isSeeking = false;
    });

    function startVisualizer() {
      function draw() {
        if (!analyser || !dataArray) return;
        animationId = requestAnimationFrame(draw);

        const width = canvas.width / (window.devicePixelRatio || 1);
        const height = canvas.height / (window.devicePixelRatio || 1);

        ctx.fillStyle = "rgba(3, 4, 9, 0.35)";
        ctx.fillRect(0, 0, width, height);

        const theme = themes[currentThemeKey] || themes.neon;
        const [c1, c2, c3] = theme.barColors;

        if (currentVisualizer === "wave") {
          drawWaveform(width, height, c1, c2, c3);
        } else if (currentVisualizer === "circle") {
          drawCircle(width, height, c1, c2, c3);
        } else {
          drawBars(width, height, c1, c2, c3);
        }
      }

      draw();
    }

    function drawBars(width, height, c1, c2, c3) {
      analyser.getByteFrequencyData(dataArray);

      const barCount = 128;
      const step = Math.floor(dataArray.length / barCount);
      const barWidth = (width / barCount) * 0.9;
      const gap = (width / barCount) * 0.1;
      const midY = height / 2;

      const grad = ctx.createLinearGradient(0, 0, width, 0);
      grad.addColorStop(0, c1);
      grad.addColorStop(0.5, c2);
      grad.addColorStop(1, c3);

      for (let i = 0; i < barCount; i++) {
        const amplitude = dataArray[i * step] / 255;
        const barHeight = amplitude * (height * 0.9) * 0.5;
        const x = i * (barWidth + gap);
        const yTop = midY - barHeight;

        ctx.fillStyle = grad;
        drawRoundRect(x, yTop, barWidth, barHeight, 5);
        ctx.fill();
        drawRoundRect(x, midY, barWidth, barHeight, 5);
        ctx.fill();
      }

      ctx.strokeStyle = "rgba(255, 255, 255, 0.08)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, midY);
      ctx.lineTo(width, midY);
      ctx.stroke();
    }

    function drawCircle(width, height, c1, c2, c3) {
      analyser.getByteFrequencyData(dataArray);

      const radius = Math.min(width, height) * 0.3;
      const centerX = width / 2;
      const centerY = height / 2;

      const grad = ctx.createLinearGradient(centerX - radius, centerY, centerX + radius, centerY);
      grad.addColorStop(0, c1);
      grad.addColorStop(0.5, c2);
      grad.addColorStop(1, c3);

      const barCount = 96;
      const step = Math.floor(dataArray.length / barCount);
      const maxBarLength = Math.min(width, height) * 0.4;

      ctx.save();
      ctx.translate(centerX, centerY);

      for (let i = 0; i < barCount; i++) {
        const amplitude = dataArray[i * step] / 255;
        const barLength = amplitude * maxBarLength;

        const angle = (i / barCount) * Math.PI * 2;
        ctx.save();
        ctx.rotate(angle);

        ctx.beginPath();
        ctx.moveTo(0, radius);
        ctx.lineTo(0, radius + barLength);
        ctx.strokeStyle = grad;
        ctx.lineWidth = Math.max(2, (Math.PI * radius) / barCount / 1.3);
        ctx.lineCap = "round";
        ctx.stroke();

        ctx.restore();
      }

      ctx.restore();

      ctx.beginPath();
      ctx.arc(centerX, centerY, radius * 0.92, 0, Math.PI * 2);
      ctx.strokeStyle = "rgba(255, 255, 255, 0.18)";
      ctx.lineWidth = 1.2;
      ctx.stroke();
    }

    function drawWaveform(width, height, c1, c2, c3) {
      analyser.getByteTimeDomainData(waveArray);

      const grad = ctx.createLinearGradient(0, 0, width, 0);
      grad.addColorStop(0, c1);
      grad.addColorStop(0.5, c2);
      grad.addColorStop(1, c3);

      ctx.lineWidth = 2;
      ctx.strokeStyle = grad;
      ctx.beginPath();

      const sliceWidth = width / waveArray.length;
      let x = 0;
      const midY = height / 2;

      for (let i = 0; i < waveArray.length; i++) {
        const v = waveArray[i] / 255;
        const y = midY + (v - 0.5) * height * 0.6;

        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }

        x += sliceWidth;
      }

      ctx.stroke();

      ctx.strokeStyle = "rgba(255, 255, 255, 0.08)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, midY);
      ctx.lineTo(width, midY);
      ctx.stroke();
    }

    function drawRoundRect(x, y, width, height, radius) {
      const r = Math.min(radius, width / 2, height / 2);
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + width - r, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + r);
      ctx.lineTo(x + width, y + height - r);
      ctx.quadraticCurveTo(x + width, y + height, x + width - r, y + height);
      ctx.lineTo(x + r, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }

    visualizerWrapper.addEventListener("click", (e) => {
      if (e.target === visualizerWrapper || e.target === canvas) {
        fileInput.click();
      }
    });

    function handleDragOver(e) {
      e.preventDefault();
      document.body.classList.add("drag-over");
    }

    function handleDragLeave(e) {
      e.preventDefault();
      if (e.target === document.body || e.clientX <= 0 || e.clientY <= 0) {
        document.body.classList.remove("drag-over");
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      document.body.classList.remove("drag-over");
      const files = e.dataTransfer.files;
      if (!files || !files.length) return;
      const file = files[0];
      loadAudioFile(file);
    }

    window.addEventListener("dragover", handleDragOver);
    window.addEventListener("dragleave", handleDragLeave);
    window.addEventListener("drop", handleDrop);

    // init
    applyTheme(currentThemeKey);
    resizeCanvas();
    resetUIToEmpty();
  </script>
</body>
</html>
